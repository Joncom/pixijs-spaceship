<!DOCTYPE html>
<html>
<head>
    <title>PixiJS Spaceship</title>
	<style type="text/css">
		html,body {
			margin: 0;
			padding: 0;
		}
	</style>
	<script type="text/javascript" src="pixi.min.js"></script>
</head>
<body>
    <script>
        var stage = new PIXI.Container();
        var renderer = PIXI.autoDetectRenderer(window.innerWidth, window.innerHeight, { antialias: false });
        document.body.appendChild(renderer.view);
        
        // always fit canvas to window
        window.onresize = function() {
            renderer.resize(window.innerWidth, window.innerHeight);
        }

        // load assets
        PIXI.loader
            .add("ship.png")
            .load(setup);

        var scale, sprite, state, particles, mouse;

        // setup game
        function setup() {
            // setup ship sprite
            sprite = new PIXI.Sprite(PIXI.loader.resources["ship.png"].texture);
            sprite.anchor.set(0.5, 0.5);
            sprite.position.set(window.innerWidth/2, window.innerHeight/2);
            sprite.vx = 0;
            sprite.vy = 0;
            sprite.speed = 4;
            sprite.zIndex = 1;
            stage.addChild(sprite);

            // capture mouse input
            renderer.view.addEventListener('mousemove', mousemove, false );
            renderer.view.addEventListener('touchstart', mousemove, false);
            renderer.view.addEventListener('touchmove', mousemove, false);
            mouse = { x: 0, y: 0 };

            particles = [];
            stars = [];

            // generate stars
            for(var i=0; i<225; i++) {
                var x = Math.floor(Math.random() * renderer.view.width);
                var y = Math.floor(Math.random() * renderer.view.height);
                stars.push(new Star(x, y));
            }

            // start game
            state = play;
            gameLoop();
        }

        function gameLoop() {
            requestAnimationFrame(gameLoop);
            state();
            renderer.render(stage);
        }

        function play() {
            // update stars
            for(var i=0; i<stars.length; i++) {
                stars[i].updateAlpha();
            }

            // update particles
            for(var i=particles.length-1; i>=0; i--) {
                particles[i].rotation += 0.1;
                particles[i].scale.x -= 0.005;
                particles[i].scale.y -= 0.005;
                if(particles[i].scale.x <= 0 || particles[i].scale.y <= 0) {
                    stage.removeChild(particles[i]);
                    particles.splice(i, 1);
                }
            }

            // generate particle
            var size = 16;
            var particle = new PIXI.Graphics();
            particle.beginFill(0xCCCCCC);
            particle.drawRect(0, 0, size, size);
            particle.endFill();
            particle.x = sprite.x-2 + Math.random() * 4;
            particle.y = sprite.y-2 + Math.random() * 4;
            particle.pivot.set(size/2);
            particle.zIndex = 0;
            particles.push(particle);
            stage.addChild(particle);

            // sort draw order by zIndex
            stage.children.sort(function(a,b) {
                a.zIndex = a.zIndex || 0;
                b.zIndex = b.zIndex || 0;
                return a.zIndex - b.zIndex;
            });

            // set ship velocity toward mouse
            var distance = Math.sqrt(Math.pow(mouse.x - sprite.x, 2) + Math.pow(mouse.y - sprite.y, 2));
            if(distance > 8) {
                var angle = Math.atan2(mouse.y - sprite.y, mouse.x - sprite.x);
                sprite.vx = Math.cos(angle) * sprite.speed;
                sprite.vy = Math.sin(angle) * sprite.speed;
            } else {
                sprite.vx = sprite.vy = 0;
            }

            // rotate ship to face moving direction
            if(sprite.vx !== 0 || sprite.vy !== 0) {
                sprite.rotation = Math.atan2(sprite.vy, sprite.vx);
            }            

            // update sprite position
            sprite.x += sprite.vx;
            sprite.y += sprite.vy;
        }

        function mousemove(ev) {
            mouse = {
                x: ev.clientX,
                y: ev.clientY
            }
        }

        function Star(x, y) {
            this.timeOffset = Math.random() * 100;
            this.fadeSpeed = 2.5;

            var z = 0.08 + Math.pow(Math.random(),1.4) * 0.92; // far stars are more likely
            var size = Math.ceil(Star.MAX_SIZE * z * z);

            this.graphic = new PIXI.Graphics();
            this.graphic.beginFill(0xFFFFFF);
            this.graphic.drawRect(0, 0, size, size);
            this.graphic.endFill();
            this.graphic.x = x;
            this.graphic.y = y;
            this.graphic.pivot.set(size/2);
            this.graphic.zIndex = -1;
            stage.addChild(this.graphic);
        }

        Star.prototype.updateAlpha = function() {
            var time = Date.now() / 1000 + this.timeOffset;
            this.graphic.alpha = 0.4 + 0.6 * Math.abs(Math.cos(time * this.fadeSpeed));
        }

        Star.MAX_SIZE = 4;

    </script>
</body>
</html>