<!DOCTYPE html>
<html>
<head>
	<style type="text/css">
		html,body {
			margin: 0;
			padding: 0;
		}
	</style>
	<script type="text/javascript" src="pixi.min.js"></script>
</head>
<body>
    <script>
        var stage = new PIXI.Container();
        var renderer = PIXI.autoDetectRenderer(window.innerWidth, window.innerHeight, { antialias: false });
        document.body.appendChild(renderer.view);
        var sprite, state, particles, scale, mouse;

        PIXI.loader
            .add("ship.png")
            .load(setup);

        function setup() {
            scale = 2;

            // setup ship sprite
            sprite = new PIXI.Sprite(PIXI.loader.resources["ship.png"].texture);
            sprite.scale.set(scale);
            sprite.texture.baseTexture.scaleMode = PIXI.SCALE_MODES.NEAREST;
            sprite.anchor.set(0.5, 0.5);
            sprite.position.set(window.innerWidth/2, window.innerHeight/2);
            sprite.vx = 0;
            sprite.vy = 0;
            sprite.speed = 2;
            sprite.zIndex = 1;
            stage.addChild(sprite);

            // capture mouse input
            renderer.view.addEventListener('mousemove', mousemove, false );
            mouse = { x: 0, y: 0 };

            particles = [];

            // start the game
            state = play;
            gameLoop();
        }

        function gameLoop() {
            requestAnimationFrame(gameLoop);
            state();
            renderer.render(stage);
        }

        function play() {
            // update particles
            for(var i=particles.length-1; i>=0; i--) {
                particles[i].rotation += 0.1;
                particles[i].scale.x -= 0.01;
                particles[i].scale.y -= 0.01;
                if(particles[i].scale.x <= 0 || particles[i].scale.y <= 0) {
                    stage.removeChild(particles[i]);
                    particles.splice(i, 1);
                }
            }

            // generate a particle
            var size = 8;
            var particle = new PIXI.Graphics();
            particle.beginFill(0xCCCCCC);
            particle.drawRect(0, 0, size, size);
            particle.endFill();
            particle.x = sprite.x-2 + Math.random() * 4;
            particle.y = sprite.y-2 + Math.random() * 4;
            particle.scale.set(2);
            particle.pivot.set(size/2);
            particle.zIndex = 0;
            particles.push(particle);
            stage.addChild(particle);

            // sort draw order by zIndex
            stage.children.sort(function(a,b) {
                a.zIndex = a.zIndex || 0;
                b.zIndex = b.zIndex || 0;
                return a.zIndex - b.zIndex;
            });

            // set ship velocity toward mouse
            var angle = Math.atan2(mouse.y - sprite.y, mouse.x - sprite.x);
            sprite.vx = Math.cos(angle) * sprite.speed;
            sprite.vy = Math.sin(angle) * sprite.speed;

            // rotate ship to face moving direction
            sprite.rotation = Math.atan2(sprite.vy, sprite.vx);

            sprite.x += sprite.vx;
            sprite.y += sprite.vy;
        }

        function mousemove(ev) {
            mouse = {
                x: ev.clientX,
                y: ev.clientY
            }
        }

    </script>
</body>
</html>