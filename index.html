<!DOCTYPE html>
<html>
<head>
	<style type="text/css">
		html,body {
			background-color: #333;
			color: #fff;
			font-family: helvetica, arial, sans-serif;
			margin: 0;
			padding: 0;
			font-size: 12pt;
		}
		
		#canvas {
			position: absolute;
			left: 0;
			right: 0;
			top: 0;
			bottom: 0;
			margin: auto;
		}
	</style>

	<script type="text/javascript" src="pixi.min.js"></script>
</head>
<body>
    <script>
        var stage = new PIXI.Container();
        var renderer = PIXI.autoDetectRenderer(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.view);
        var sprite, state, left, up, right, down, particles;

        PIXI.loader
            .add("ship.png")
            .load(setup);

        function setup() {
            // setup ship sprite
            sprite = new PIXI.Sprite(PIXI.loader.resources["ship.png"].texture);
            sprite.anchor.set(0.5, 0.5);
            sprite.position.set(window.innerWidth/2, window.innerHeight/2);
            sprite.vx = 0;
            sprite.vy = 0;
            sprite.speed = 1;
            stage.addChild(sprite);

            // capture keyboard input
            left = keyboard(37);
            up = keyboard(38);
            right = keyboard(39);
            down = keyboard(40);

            particles = [];

            // set game state
            state = play;
            
            // start the game
            gameLoop();
        }

        function gameLoop() {
            requestAnimationFrame(gameLoop);
            state();
            renderer.render(stage);
        }

        function play() {
            // update particles
            for(var i=particles.length-1; i>=0; i--) {
                particles[i].rotation += 0.1;
                particles[i].scale.x -= 0.01;
                particles[i].scale.y -= 0.01;
                if(particles[i].scale.x <= 0 || particles[i].scale.y <= 0) {
                    stage.removeChild(particles[i]);
                    particles.splice(i, 1);
                }
            }

            // generate particles
            for( var i=0; i<1; i++) {
                var particle = new PIXI.Graphics();
                particle.beginFill(0xCCCCCC);
                particle.drawRect(0, 0, 8, 8);
                particle.endFill();
                particle.x = sprite.x;
                particle.y = sprite.y;
                particles.push(particle);
                stage.addChild(particle);
            }

            // update horizontal velocity
            if(left.isDown && !right.isDown) {
                sprite.vx = -sprite.speed;
            } else if(right.isDown && !left.isDown) {
                sprite.vx = sprite.speed;
            } else {
                sprite.vx = 0;
            }
            
            // update vertical velocity
            if(up.isDown && !down.isDown) {
                sprite.vy = -sprite.speed;
            } else if(down.isDown && !up.isDown) {
                sprite.vy = sprite.speed;
            } else {
                sprite.vy = 0;
            }

            // rotate ship to face moving direction
            sprite.rotation = Math.atan2(sprite.vy, sprite.vx);

            sprite.x += sprite.vx;
            sprite.y += sprite.vy;
        }

        function keyboard(keyCode) {
            var key = {};
            key.code = keyCode;
            key.isDown = false;
            key.isUp = true;
            key.press = undefined;
            key.release = undefined;

            key.downHandler = function (event) {
                if (event.keyCode === key.code) {
                    if (key.isUp && key.press) key.press();
                    key.isDown = true;
                    key.isUp = false;
                }
                event.preventDefault();
            };

            key.upHandler = function (event) {
                if (event.keyCode === key.code) {
                    if (key.isDown && key.release) key.release();
                    key.isDown = false;
                    key.isUp = true;
                }
                event.preventDefault();
            };

            window.addEventListener("keydown", key.downHandler.bind(key), false);
            window.addEventListener("keyup", key.upHandler.bind(key), false);
            return key;
        }

    </script>
</body>
</html>